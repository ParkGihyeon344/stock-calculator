<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>물타기 계산기(주식/해외주식/코인/선물)</title>
  <style>
    body {
      background-color: #fff;
      color: #222;
      font-family: 'Pretendard', sans-serif;
      padding: 20px;
      margin: auto;
      max-width: 600px;
    }
    h1 {
      text-align: center;
      color: #4CAF50;
      margin-bottom: 10px;
    }
    #exchangeBoard {
      position: fixed;
      top: 10px;
      right: 10px;
      background: linear-gradient(90deg, #000, #111);
      color: #0f0;
      padding: 10px 16px;
      font-size: 14px;
      font-weight: bold;
      border-radius: 10px;
      white-space: nowrap;
      box-shadow: 0 0 10px rgba(0,0,0,0.3);
      border: 2px solid #0f0;
      z-index: 999;
    }
    select, input, button {
      width: 100%;
      padding: 14px;
      margin: 10px 0;
      border-radius: 8px;
      border: 2px solid #4CAF50;
      font-size: 16px;
      box-sizing: border-box;
    }
    label {
      font-weight: bold;
      display: block;
      margin-top: 10px;
    }
    button {
      background-color: #4CAF50;
      color: white;
      font-weight: bold;
      cursor: pointer;
    }
    .result {
      margin-top: 20px;
      padding: 20px;
      background: #f7f7f7;
      border-radius: 10px;
      border: 1px solid #ddd;
    }
    .error {
      color: red;
      font-weight: bold;
      margin-top: 10px;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 10px;
    }
    th, td {
      padding: 10px;
      text-align: center;
      border-bottom: 1px solid #ccc;
    }
    th {
      background-color: #f0f0f0;
    }
    @media screen and (max-width: 600px) {
      body {
        padding: 10px;
      }
      h1 {
        font-size: 20px;
      }
      input, button, select {
        font-size: 14px;
        padding: 10px;
      }
      #exchangeBoard {
        font-size: 12px;
        padding: 8px 12px;
      }
    }
  </style>
  <meta name="description" content="물타기 계산기 - 주식, 코인, 선물까지 다양한 투자 자산의 평균단가와 수익률을 계산해보세요.">
  <meta name="keywords" content="물타기 계산기, 주식, 코인, 선물, 평균단가, 수익률 계산">
  <meta name="author" content="ParkGihyeon344">
</head>
<body>

<div id="exchangeBoard">USD/KRW: 불러오는 중...</div>

<h1>📊 물타기 계산기</h1>

<label for="type">계산기 종류 선택</label>
<select id="type" onchange="toggleType()">
  <option value="stock">📈 주식/해외주식</option>
  <option value="coin">💰 코인</option>
  <option value="stockfut">🧭 주식선물</option>
  <option value="coinfut">🌐 코인선물</option>
</select>

<label>📌 종목명</label>
<input type="text" id="stockName" placeholder="예: 비트코인, 삼성전자" list="nameList">
<datalist id="nameList">
  <option value="비트코인">
  <option value="이더리움">
  <option value="삼성전자">
  <option value="테슬라">
  <option value="에스엠">
  <option value="엔비디아">
</datalist>

<label>📊 현재 보유 수량</label>
<input type="number" id="quantity" placeholder="예: 0.5">

<label>📉 현재 수익률 (%)</label>
<input type="number" id="currentRate" placeholder="예: -10">

<label>➕ 추가 매수 금액 (₩)</label>
<input type="number" id="addAmount" placeholder="예: 50000">

<button onclick="calculate()">물타기 계산하기</button>

<div class="result" id="result"></div>
<div class="error" id="error"></div>

<script>
async function getExchangeRate() {
  try {
    const res = await fetch("https://api.exchangerate.host/latest?base=USD&symbols=KRW");
    const data = await res.json();
    if (data.rates && data.rates.KRW) {
      localStorage.setItem("lastExchangeRate", data.rates.KRW);
      return data.rates.KRW;
    } else {
      throw new Error("API 구조 오류");
    }
  } catch (e) {
    const cachedRate = localStorage.getItem("lastExchangeRate");
    if (cachedRate) {
      document.getElementById("exchangeBoard").innerText = `USD/KRW: ₩${parseFloat(cachedRate).toLocaleString(undefined, {maximumFractionDigits:2})} (이전)`;
      return parseFloat(cachedRate);
    } else {
      document.getElementById("exchangeBoard").innerText = "환율 정보를 불러오지 못했습니다.";
      return 1350;
    }
  }
}

getExchangeRate().then(rate => {
  if (rate) {
    document.getElementById("exchangeBoard").innerText = `USD/KRW: ₩${rate.toLocaleString(undefined, {maximumFractionDigits:2})}`;
  }
});

function toggleType() {
  const type = document.getElementById("type").value;
  const label = document.querySelector("label[for='type']");
  if (type === 'coin') label.textContent = "코인명";
  else if (type === 'stock') label.textContent = "종목명";
  else if (type === 'stockfut') label.textContent = "주식선물명";
  else if (type === 'coinfut') label.textContent = "코인선물명";
}

function calculate() {
  const name = document.getElementById("stockName").value.trim();
  const quantity = Number(document.getElementById("quantity").value);
  const rate = Number(document.getElementById("currentRate").value);
  const addAmount = Number(document.getElementById("addAmount").value);

  const errorDiv = document.getElementById("error");
  const resultDiv = document.getElementById("result");
  errorDiv.innerText = "";
  resultDiv.innerHTML = "";

  if (!name || !quantity || isNaN(rate) || !addAmount) {
    errorDiv.innerText = "❗ 모든 입력값을 채워주세요.";
    return;
  }

  const nowPrice = (quantity * 100) / (100 + rate);
  const originalTotal = nowPrice * quantity;
  const additionalQty = addAmount / nowPrice;
  const totalQty = quantity + additionalQty;
  const newTotal = originalTotal + addAmount;
  const newVal = nowPrice * totalQty;
  const newRate = ((newVal - newTotal) / newTotal) * 100;
  const profit = newVal - newTotal;

  resultDiv.innerHTML = `
    <table>
      <thead>
        <tr>
          <th>종목명</th>
          <th>평가손익</th>
          <th>수익률</th>
          <th>보유수량</th>
          <th>평가금액</th>
        </tr>
      </thead>
      <tbody>
        <tr>
          <td>${name}</td>
          <td style="color:${profit >= 0 ? 'blue' : 'red'}">₩${profit.toLocaleString(undefined, {maximumFractionDigits:0})}</td>
          <td style="color:${newRate >= 0 ? 'blue' : 'red'}">${newRate.toFixed(2)}%</td>
          <td>${totalQty.toFixed(4)}단위</td>
          <td>₩${newVal.toLocaleString(undefined, {maximumFractionDigits:0})}</td>
        </tr>
      </tbody>
    </table>
  `;
}
</script>

</body>
</html>
